name: server-stack

networks:
  stack:
    name: ${STACK_NETWORK}
    driver: bridge

volumes:
  mysql_data:
  postgres_data:
  n8n_data:
  redis_data:

services:
  app_dev:
    build:
      context: ./docker/php-fpm
      dockerfile: Dockerfile
    image: ${PHP_IMAGE}
    container_name: ${APP_NAME}_php_dev
    working_dir: /var/www/app
    command: ["php-fpm", "-F"]
    volumes:
      - ${APP_PATH_DEV}:/var/www/app:delegated
    environment:
      TZ: ${TZ}
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /var/www/app/artisan || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks: [stack]

  app_prod:
    build:
      context: ./docker/php-fpm
      dockerfile: Dockerfile
    image: ${PHP_IMAGE}
    container_name: ${APP_NAME}_php_prod
    working_dir: /var/www/app
    command: ["php-fpm", "-F"]
    volumes:
      - ${APP_PATH_PROD}:/var/www/app:delegated
    environment:
      TZ: ${TZ}
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /var/www/app/artisan || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks: [stack]

  node_builder_dev:
    image: ${NODE_IMAGE}
    container_name: ${APP_NAME}_node_builder_dev
    working_dir: /var/www/app
    volumes:
      - ${APP_PATH_DEV}:/var/www/app:delegated
    environment:
      TZ: ${TZ}
    networks: [stack]

  node_builder_prod:
    image: ${NODE_IMAGE}
    container_name: ${APP_NAME}_node_builder_prod
    working_dir: /var/www/app
    volumes:
      - ${APP_PATH_PROD}:/var/www/app:delegated
    environment:
      TZ: ${TZ}
    networks: [stack]

  composer_dev:
    build:
      context: ./docker/composer
      dockerfile: Dockerfile
    image: ${COMPOSER_IMAGE}
    container_name: ${APP_NAME}_composer_dev
    working_dir: /app
    entrypoint: ["composer"]
    volumes:
      - ${APP_PATH_DEV}:/app:delegated
    networks: [stack]

  composer_prod:
    build:
      context: ./docker/composer
      dockerfile: Dockerfile
    image: ${COMPOSER_IMAGE}
    container_name: ${APP_NAME}_composer_prod
    working_dir: /app
    entrypoint: ["composer"]
    volumes:
      - ${APP_PATH_PROD}:/app:delegated
    networks: [stack]

  mysql:
    image: ${MYSQL_IMAGE}
    container_name: mysql
    environment:
      TZ: ${TZ}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE_DEV: ${MYSQL_DATABASE_DEV}
      MYSQL_USER_DEV: ${MYSQL_USER_DEV}
      MYSQL_PASSWORD_DEV: ${MYSQL_PASSWORD_DEV}
      MYSQL_DATABASE_PROD: ${MYSQL_DATABASE_PROD}
      MYSQL_USER_PROD: ${MYSQL_USER_PROD}
      MYSQL_PASSWORD_PROD: ${MYSQL_PASSWORD_PROD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sh:/docker-entrypoint-initdb.d/01-init-users.sh:ro
    networks: [stack]

  postgres:
    image: ${POSTGRES_IMAGE}
    container_name: postgres
    environment:
      TZ: ${TZ}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_TODOMAP_DB: ${POSTGRES_TODOMAP_DB}
      POSTGRES_TODOMAP_USER: ${POSTGRES_TODOMAP_USER}
      POSTGRES_TODOMAP_PASSWORD: ${POSTGRES_TODOMAP_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sh:/docker-entrypoint-initdb.d/01-init-todomap.sh:ro
    networks: [stack]

  n8n:
    image: ${N8N_IMAGE}
    container_name: n8n
    environment:
      TZ: ${TZ}
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_HOST: ${N8N_HOST}
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      N8N_PORT: ${N8N_PORT}
      N8N_EDITOR_BASE_URL: ${N8N_PROTOCOL}://${N8N_HOST}
      WEBHOOK_URL: ${N8N_PROTOCOL}://${N8N_HOST}/
    volumes:
      - n8n_data:/home/node/.n8n
    networks: [stack]
    expose:
      - "5678"

  claude_cli:
    build:
      context: ./docker/claude-cli
      dockerfile: Dockerfile
    image: ${CLAUDE_CLI_IMAGE}
    container_name: claude_cli
    restart: unless-stopped
    working_dir: /workspace
    command: ["tail", "-f", "/dev/null"]
    environment:
      TZ: ${TZ}
      STACK_NETWORK: ${STACK_NETWORK}
      COMPOSE_PROJECT_NAME: server-stack
      DOCKER_HOST: unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - /srv/apps:/srv/apps:rw
      - .:/stack:ro
    networks: [stack]

  redis:
    image: ${REDIS_IMAGE}
    container_name: redis
    restart: unless-stopped
    environment:
      TZ: ${TZ}
    volumes:
      - redis_data:/data
    networks: [stack]
    command: redis-server --appendonly yes

  generatemedia_web:
    build:
      context: ${GENERATEMEDIA_APP_PATH}
      dockerfile: /srv/docker/stack-vps-multiapp/docker/nextjs/Dockerfile
    image: ${GENERATEMEDIA_IMAGE}
    container_name: generatemedia_web
    restart: unless-stopped
    working_dir: /app
    env_file:
      - ${GENERATEMEDIA_APP_PATH}/.env
    environment:
      TZ: ${TZ}
      NODE_ENV: production
      DATABASE_URL: postgresql://${GENERATEMEDIA_DB_USER}:${GENERATEMEDIA_DB_PASS}@postgres:5432/${GENERATEMEDIA_DB_NAME}
      REDIS_URL: ${GENERATEMEDIA_REDIS_URL}
      GENERATEMEDIA_PUBLIC_BASE_URL: ${GENERATEMEDIA_PUBLIC_BASE_URL}
      GENERATEMEDIA_API_KEY: ${GENERATEMEDIA_API_KEY}
    volumes:
      - /srv/apps/generatemedia/uploads:/app/uploads:rw
    depends_on:
      - postgres
      - redis
    expose:
      - "3000"
    networks: [stack]

  generatemedia_worker:
    image: ${GENERATEMEDIA_IMAGE}
    container_name: generatemedia_worker
    restart: unless-stopped
    working_dir: /app
    command: ["npm", "run", "worker"]
    env_file:
      - ${GENERATEMEDIA_APP_PATH}/.env
    environment:
      TZ: ${TZ}
      NODE_ENV: production
      DATABASE_URL: postgresql://${GENERATEMEDIA_DB_USER}:${GENERATEMEDIA_DB_PASS}@postgres:5432/${GENERATEMEDIA_DB_NAME}
      REDIS_URL: ${GENERATEMEDIA_REDIS_URL}
      GENERATEMEDIA_PUBLIC_BASE_URL: ${GENERATEMEDIA_PUBLIC_BASE_URL}
      GENERATEMEDIA_API_KEY: ${GENERATEMEDIA_API_KEY}
    volumes:
      - /srv/apps/generatemedia/uploads:/app/uploads:rw
    depends_on:
      - postgres
      - redis
      - generatemedia_web
    networks: [stack]
